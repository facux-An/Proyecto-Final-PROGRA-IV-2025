{% extends 'ventas/base_ventas.html' %}
{% load static %}

{% block title %}Checkout Seguro · Tienda Plus{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-5">
        <div class="col-12 text-center">
            <div class="d-flex justify-content-center align-items-center mb-3">
                <div class="step-item text-success">
                    <span class="step-badge border-success"><i class="bi bi-check2"></i></span>
                    <small class="d-block mt-2 fw-bold">Carrito</small>
                </div>
                <div class="step-line bg-success"></div>
                <div class="step-item text-primary">
                    <span class="step-badge bg-primary text-white border-primary shadow">2</span>
                    <small class="d-block mt-2 fw-bold">Pago</small>
                </div>
                <div class="step-line"></div>
                <div class="step-item text-muted">
                    <span class="step-badge border-secondary">3</span>
                    <small class="d-block mt-2">Confirmación</small>
                </div>
            </div>
            <h2 class="fw-bold mt-4">Finalizar Compra</h2>
            <p class="text-muted">Elegí el medio de pago para completar tu pedido</p>
        </div>
    </div>

    <form id="form-pago" method="post" action="">
        {% csrf_token %}
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm p-4" style="border-radius: 1.5rem;">
                    <h5 class="fw-bold mb-4 d-flex align-items-center">
                        <i class="bi bi-shield-lock-fill text-primary me-2"></i>
                        Métodos de pago seguros
                    </h5>

                    <div class="payment-card mb-3" onclick="seleccionarMetodo('mercadopago', this)">
                        <input type="radio" name="metodo" value="mercadopago" class="d-none">
                        <div class="card-body d-flex align-items-center p-3 border rounded-4 transition-card">
                            <div class="icon-circle bg-primary-light me-3">
                                <i class="bi bi-credit-card-2-front text-primary fs-4"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-0 fw-bold">Mercado Pago</h6>
                                <small class="text-muted d-none d-md-block">Tarjetas de crédito, débito o dinero en cuenta.</small>
                            </div>
                            <div class="ms-auto">
                                <img src="https://http2.mlstatic.com/frontend-assets/mp-web-navigation/ui-navigation/5.21.22/mercadopago/logo__large.png" alt="MP" style="height: 20px;">
                            </div>
                        </div>
                    </div>

                    <div class="payment-card mb-3" onclick="seleccionarMetodo('transferencia', this)">
                        <input type="radio" name="metodo" value="transferencia" class="d-none">
                        <div class="card-body d-flex align-items-center p-3 border rounded-4 transition-card">
                            <div class="icon-circle bg-success-light me-3">
                                <i class="bi bi-bank text-success fs-4"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-0 fw-bold text-dark">Transferencia Bancaria</h6>
                                <small class="text-muted d-none d-md-block">Los datos del CBU aparecerán al confirmar.</small>
                            </div>
                            <i class="bi bi-chevron-right text-muted opacity-50"></i>
                        </div>
                    </div>

                    <div class="payment-card mb-3" onclick="seleccionarMetodo('efectivo', this)">
                        <input type="radio" name="metodo" value="efectivo" class="d-none">
                        <div class="card-body d-flex align-items-center p-3 border rounded-4 transition-card">
                            <div class="icon-circle bg-dark-light me-3">
                                <i class="bi bi-cash-stack text-dark fs-4"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-0 fw-bold text-dark">Efectivo / Al retirar</h6>
                                <small class="text-muted d-none d-md-block">Pagás directamente en nuestro local.</small>
                            </div>
                            <i class="bi bi-chevron-right text-muted opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card border-0 shadow-lg p-4 sticky-top" style="border-radius: 1.5rem; top: 2rem; border: 1px solid rgba(0,0,0,.05) !important;">
                    <h5 class="fw-bold mb-4 text-center">Resumen</h5>
                    <div class="summary-box bg-light p-3 rounded-4 mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">Total a pagar:</span>
                            <span class="h3 fw-bold text-primary mb-0">${{ total_a_pagar|floatformat:2 }}</span>
                        </div>
                    </div>

                    <button type="submit" id="btn-finalizar" class="btn btn-secondary btn-lg w-100 py-3 fw-bold shadow-sm" style="border-radius: 12px;" disabled>
                        Elegí un método
                    </button>
                    
                    <a href="{% url 'carrito:carrito_detail' %}" class="btn btn-link w-100 text-muted mt-3 text-decoration-none small">
                        <i class="bi bi-arrow-left me-1"></i> Volver al carrito
                    </a>
                    
                    <div class="mt-4 pt-4 border-top text-center text-muted">
                        <p style="font-size: 0.75rem;">
                            <i class="bi bi-lock-fill me-1"></i> Pago 100% procesado de forma segura.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
    body { background-color: #f8faff; }
    .transition-card { transition: all 0.2s ease-in-out; border: 2px solid #f1f3f5 !important; cursor: pointer; position: relative; }
    
    /* Indicador de pasos */
    .step-badge { width: 40px; height: 40px; border: 2px solid #dee2e6; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 0 auto; }
    .step-line { width: 60px; height: 2px; background-color: #dee2e6; margin-bottom: 25px; }

    /* Colores suaves para iconos */
    .icon-circle { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .bg-primary-light { background-color: #eef4ff; }
    .bg-success-light { background-color: #e9f7ef; }
    .bg-dark-light { background-color: #f1f3f5; }

    /* Estado ACTIVO (Esto es lo que el JS activará) */
    .payment-card.active .card-body {
        border-color: #0d6efd !important;
        background-color: #f0f6ff;
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(13, 110, 253, 0.1);
    }

    .payment-card.active .icon-circle { background-color: #ffffff; }

    /* Checkmark visual */
    .payment-card.active .card-body::after {
        content: '\F26E'; font-family: 'bootstrap-icons'; position: absolute;
        top: 10px; right: 15px; color: #0d6efd; font-size: 1.2rem;
    }

    .btn-primary { background: linear-gradient(135deg, #0d6efd, #0b5ed7); border: none; }
    .btn-success { background: linear-gradient(135deg, #198754, #157347); border: none; }
</style>

<script>
    /**
     * Esta función se dispara cada vez que el usuario hace clic en una tarjeta de pago.
     */
    function seleccionarMetodo(metodo, elemento) {
        // 1. Desmarcar visualmente todas las tarjetas
        const todasLasTarjetas = document.querySelectorAll('.payment-card');
        todasLasTarjetas.forEach(t => t.classList.remove('active'));

        // 2. Marcar como activa la tarjeta clickeada
        elemento.classList.add('active');

        // 3. Seleccionar el Radio Button interno (para que Django reciba el POST)
        const radioInterno = elemento.querySelector('input[type="radio"]');
        if (radioInterno) {
            radioInterno.checked = true;
        }

        // 4. Configurar el botón de Finalizar
        const btn = document.getElementById('btn-finalizar');
        btn.disabled = false; // ¡AQUÍ SE HABILITA EL BOTÓN!

        if (metodo === 'mercadopago') {
            btn.innerHTML = '<i class="bi bi-credit-card-fill me-2"></i> Pagar con Mercado Pago';
            btn.className = 'btn btn-primary btn-lg w-100 py-3 fw-bold shadow-sm';
        } else {
            btn.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i> Confirmar Mi Pedido';
            btn.className = 'btn btn-success btn-lg w-100 py-3 fw-bold shadow-sm';
        }

        console.log("Método seleccionado:", metodo); // Solo para debug
    }
</script>
{% endblock %}