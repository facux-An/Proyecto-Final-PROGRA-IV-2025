{% extends 'base.html' %}
{% load static %}
{% load dict_extras %}

{% block title %}Resumen · Tienda Plus{% endblock %}

{% block hero %}
<div class="hero p-4 p-md-5 mb-4">
  <div class="d-flex flex-wrap align-items-center justify-content-between">
    <div>
      <h1 class="h3 mb-2"><i class="bi bi-graph-up-arrow me-2"></i>Resumen de actividad</h1>
      <p class="mb-0 opacity-75">Un vistazo claro a tus pedidos, estados y productos más pedidos.</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'pedidos:list' %}" class="btn btn-light btn-sm">
        <i class="bi bi-receipt-cutoff me-1"></i>Ver mis pedidos
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb-wrapper mb-3">
  <nav aria-label="miga de pan">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'home' %}">Inicio</a></li>
      <li class="breadcrumb-item active" aria-current="page">Resumen</li>
    </ol>
  </nav>
</div>
{% endblock %}

{% block content %}
<form method="get" class="section-card p-3 mb-4">
  <div class="row g-3 align-items-end">
    <div class="col-md-3">
      <label class="form-label">Estado</label>
      <select name="estado" class="form-select">
        <option value="">Todos</option>
        {% for estado in estados %}
          <option value="{{ estado }}" {% if f_estado == estado %}selected{% endif %}>{{ estado|capfirst }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Desde</label>
      <input type="date" name="desde" class="form-control" value="{{ f_desde }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Hasta</label>
      <input type="date" name="hasta" class="form-control" value="{{ f_hasta }}">
    </div>
    <div class="col-md-3 d-grid">
      <button class="btn btn-primary">Aplicar filtros</button>
    </div>
  </div>
</form>

<div class="row g-3">
  <div class="col-md-4">
    <div class="section-card p-3 text-center">
      <div class="mb-2"><i class="bi bi-collection fs-3 text-primary"></i></div>
      <h6 class="text-muted mb-1">Total de pedidos</h6>
      <div class="display-6">{{ total_pedidos }}</div>
    </div>
  </div>

  <div class="col-md-8">
    <div class="section-card p-3">
      <h6 class="mb-3"><i class="bi bi-bar-chart-line me-2"></i>Pedidos por estado</h6>
      <canvas id="graficoEstados" height="120"></canvas>
    </div>
  </div>

  <div class="col-md-6">
    <div class="section-card p-3">
      <h6 class="mb-3"><i class="bi bi-box-seam me-2"></i>Top productos por cantidad</h6>
      {% if top_productos %}
        <ul class="list-group list-group-flush">
          {% for p in top_productos %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>{{ p.producto__nombre }}</span>
              <span class="badge bg-primary rounded-pill">{{ p.total_cantidad }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted mb-0">Aún no hay datos suficientes.</p>
      {% endif %}
    </div>
  </div>

  <div class="col-md-6">
    <div class="section-card p-3 text-center">
      <h6 class="mb-3"><i class="bi bi-currency-dollar me-2"></i>Volumen total</h6>
      <div class="display-6">{{ volumen_total }}</div>
      <p class="text-muted mb-0">Cantidad total de productos pedidos</p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Datos JSON seguros para evitar errores en el editor -->
<script id="data-estados" type="application/json">
  {{ stats_estados|safe }}
</script>

<script>
  const rawData = document.getElementById("data-estados").textContent;
  const dataEstados = JSON.parse(rawData);
  const labels = Object.keys(dataEstados).map(e => e.charAt(0).toUpperCase() + e.slice(1));
  const values = Object.values(dataEstados);

  new Chart(document.getElementById('graficoEstados'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Pedidos',
        data: values,
        backgroundColor: '#0d6efd',
        borderRadius: 6
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { precision: 0 }
        }
      }
    }
  });
</script>
{% endblock %}
