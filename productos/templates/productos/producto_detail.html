{% extends 'base.html' %}
{% load static %}

{% block title %}{{ producto.nombre }} · Tienda Plus{% endblock %}

{% block content %}
<div class="row g-5">
    <div class="col-lg-7">
        <div class="card border-0 shadow-sm p-3 mb-4 rounded-4">
            <div id="mainImageContainer" class="position-relative overflow-hidden rounded-4 mb-3" style="height: 500px;">
                {% if portadas and portadas|length > 0 %}
                    <img id="mainImage" src="{{ portadas.first.imagen.url }}" class="w-100 h-100 object-fit-cover" alt="{{ producto.nombre }}">
                {% elif producto.portada and producto.portada.url %}
                    <img id="mainImage" src="{{ producto.portada.url }}" class="w-100 h-100 object-fit-cover" alt="{{ producto.nombre }}">
                {% else %}
                    <div class="d-flex align-items-center justify-content-center h-100 bg-light">
                        <i class="bi bi-camera text-muted display-1"></i>
                    </div>
                {% endif %}
                
                {% if producto.stock == 0 %}
                    <span class="position-absolute top-0 end-0 m-3 badge bg-danger fs-6 py-2 px-3 rounded-pill shadow-sm">Agotado</span>
                {% elif producto.stock < 5 %}
                    <span class="position-absolute top-0 end-0 m-3 badge bg-warning text-dark fs-6 py-2 px-3 rounded-pill shadow-sm">¡Últimos {{ producto.stock }}!</span>
                {% endif %}
            </div>

            {% if portadas and portadas|length > 1 %}
            <div class="d-flex gap-2 overflow-auto pb-2">
                {% for portada in portadas %}
                <button onclick="changeImage('{{ portada.imagen.url }}')" class="btn p-0 border-0 rounded-3 overflow-hidden shadow-sm thumb-btn" style="width: 80px; height: 80px;">
                    <img src="{{ portada.imagen.url }}" class="w-100 h-100 object-fit-cover opacity-75 hover-opacity-100 transition">
                </button>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="d-none d-lg-block">
            <h4 class="fw-bold mb-3">Descripción</h4>
            <p class="text-muted leading-relaxed">{{ producto.descripcion|linebreaks }}</p>
        </div>
    </div>

    <div class="col-lg-5">
        <div class="sticky-top" style="top: 100px; z-index: 10;">
            <div class="card border-0 shadow-lg p-4 rounded-4">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-2 small text-muted">
                        <li class="breadcrumb-item"><a href="{% url 'productos:producto_list' %}" class="text-decoration-none text-muted">Catálogo</a></li>
                        <li class="breadcrumb-item active">{{ producto.categoria.nombre|default:"General" }}</li>
                    </ol>
                </nav>

                <h1 class="fw-extrabold display-6 mb-2">{{ producto.nombre }}</h1>
                
                <div class="d-flex align-items-center mb-4">
                    <div class="h2 fw-bold text-primary mb-0">${{ producto.precio|floatformat:2 }}</div>
                    {% if producto.stock > 0 %}
                        <span class="badge bg-success-subtle text-success ms-3 rounded-pill px-3">
                            <i class="bi bi-check-circle-fill me-1"></i>En Stock
                        </span>
                    {% endif %}
                </div>

                <hr class="text-muted opacity-25 my-4">

                <div class="d-lg-none mb-4">
                    <p class="text-muted">{{ producto.descripcion|truncatewords:20 }}</p>
                </div>

                {% if user.is_staff %}
                    <div class="d-grid gap-2 mb-3">
                        <a href="{% url 'productos:producto_update' producto.id %}" class="btn btn-outline-warning fw-bold">
                            <i class="bi bi-pencil me-2"></i>Editar Producto
                        </a>
                    </div>
                {% endif %}

                {% if producto.stock > 0 %}
                    <form method="post" action="{% url 'carrito:carrito_add' producto.id %}">
                        {% csrf_token %}
                        <div class="d-grid gap-3">
                            <button type="submit" class="btn btn-primary btn-lg rounded-pill fw-bold py-3 shadow-sm btn-hover-scale">
                                <i class="bi bi-cart-plus-fill me-2"></i>Agregar al Carrito
                            </button>
                            <a href="#" class="btn btn-outline-secondary rounded-pill fw-bold">
                                <i class="bi bi-heart me-2"></i>Guardar en Favoritos
                            </a>
                        </div>
                    </form>
                    
                    <div class="mt-4 d-flex align-items-center justify-content-center text-muted small">
                        <i class="bi bi-shield-check fs-5 me-2 text-primary"></i>
                        <span>Compra protegida y envío garantizado.</span>
                    </div>
                {% else %}
                    <div class="alert alert-warning border-0 rounded-3 shadow-sm">
                        <i class="bi bi-bell-fill me-2"></i>Te avisaremos cuando haya stock.
                    </div>
                    <button class="btn btn-secondary w-100 rounded-pill" disabled>Sin Stock</button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="mt-5 pt-5 border-top">
    <h3 class="fw-bold mb-4">También te podría interesar</h3>
    <div class="row g-4">
        {% for rel in relacionados %}
        <div class="col-6 col-md-3">
            <div class="card h-100 border-0 shadow-sm product-card hover-lift rounded-4">
                <div class="position-relative rounded-top-4 overflow-hidden" style="height: 200px;">
                    <a href="{% url 'productos:producto_detail' rel.id %}">
                    {% if rel.portadas.all %}
                        <img src="{{ rel.portadas.first.imagen.url }}" class="w-100 h-100 object-fit-cover" alt="{{ rel.nombre }}">
                    {% elif rel.portada and rel.portada.url %}
                        <img src="{{ rel.portada.url }}" class="w-100 h-100 object-fit-cover" alt="{{ rel.nombre }}">
                    {% else %}
                        <div class="bg-light w-100 h-100 d-flex align-items-center justify-content-center">
                            <i class="bi bi-image text-muted"></i>
                        </div>
                    {% endif %}
                    </a>
                </div>
                <div class="card-body p-3">
                    <h6 class="fw-bold text-truncate">{{ rel.nombre }}</h6>
                    <div class="text-primary fw-bold">${{ rel.precio|floatformat:0 }}</div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12 text-muted">No hay productos relacionados por ahora.</div>
        {% endfor %}
    </div>
</div>

<style>
    .object-fit-cover { object-fit: cover; }
    .hover-lift { transition: transform 0.2s; }
    .hover-lift:hover { transform: translateY(-5px); }
    .btn-hover-scale:hover { transform: scale(1.02); }
    .thumb-btn:focus { outline: 2px solid var(--brand-primary); }
    .leading-relaxed { line-height: 1.8; }
</style>

<script>
    function changeImage(src) {
        document.getElementById('mainImage').src = src;
    }
</script>
{% endblock %}